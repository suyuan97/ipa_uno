<!-- File: game.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IPA UNO - Game</title>
    <style>
      body {
        font-family: sans-serif;
        background: #fff;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: visible;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: visible;
      }
      .game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: visible;
      }

      /* Remove the header panel */
      .game-header {
        display: none !important;
      }

      .game-board {
        flex: 1 1 auto;
        height: auto;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        min-height: 500px;
        background: none;
        overflow: visible;
      }

      .human-player {
        position: relative;
        bottom: 0;
        left: 0;
        right: 0;
        text-align: center;
        background: #f6faff;
        padding: 15px 0 10px 0;
        box-shadow: 0 -4px 16px rgba(125, 182, 232, 0.12);
        border: none;
        transition: box-shadow 0.3s;
        z-index: 10;
      }
      .human-player.active {
        box-shadow: 0 -4px 24px 0 rgba(125, 182, 232, 0.25);
        background: rgba(125, 182, 232, 0.08);
      }

      .pile-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 120px;
        height: 160px;
        /* Ensures enough space for the card to be centered */
      }

      .card {
        display: inline-block;
        margin: 5px;
        padding: 15px 20px;
        border: 2px solid #444;
        border-radius: 12px;
        cursor: default;
        font-size: 1.5rem;
        min-width: 60px;
        max-width: 80px;
        background-color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .pile-card {
        margin: 0 auto;
        box-shadow: 0 0 0 6px #7db6e8, 0 8px 32px 0 rgba(33, 150, 243, 0.45),
          0 2px 16px 0 rgba(0, 0, 0, 0.25);
        z-index: 10;
        position: relative;
        animation: pop-pile-card 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        text-align: center;
      }

      @keyframes pop-pile-card {
        0% {
          transform: scale(0.7);
          opacity: 0.5;
        }
        80% {
          transform: scale(1.1);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      }

      .card-label {
        display: block;
        font-size: 0.7rem;
        margin-top: 5px;
        text-align: center;
      }

      .hint {
        background-color: yellow !important;
      }

      .reverse {
        background: linear-gradient(135deg, #ff5722, #e91e63) !important;
        border-color: #d32f2f !important;
        color: white !important;
        font-weight: bold !important;
        animation: reverse-glow 2s ease-in-out infinite alternate;
      }

      @keyframes reverse-glow {
        from {
          box-shadow: 0 0 5px rgba(255, 87, 34, 0.5);
        }
        to {
          box-shadow: 0 0 20px rgba(255, 87, 34, 0.8),
            0 0 30px rgba(233, 30, 99, 0.6);
        }
      }

      .ai-player {
        position: absolute;
        padding: 10px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        border: 2px solid #ccc;
        text-align: center;
        min-width: 120px;
        overflow: visible;
      }

      .ai-player h3 {
        margin: 0 0 10px 0;
        font-size: 1rem;
      }

      .ai-cards {
        display: flex;
        justify-content: center;
        gap: 3px;
        flex-wrap: wrap;
      }

      .ai-card {
        width: 30px;
        height: 45px;
        background: #2196f3;
        border: 2px solid #1976d2;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.9rem;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .ai-card.back {
        background: #7db6e8 url("wug.png") center center/contain no-repeat;
        border-color: #7db6e8;
      }

      .ai-card.played {
        opacity: 0.3;
        transform: scale(0.8);
      }

      /* AI Player Positions */
      .ai-player.ai-1 {
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
      }

      .ai-player.ai-2 {
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
      }

      .ai-player.ai-3 {
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
      }

      .human-player {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        text-align: center;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-top: 2px solid #4caf50;
      }

      .human-player h2 {
        margin: 0 0 10px 0;
        font-size: 1.2rem;
      }

      .hand {
        display: flex;
        justify-content: center;
        gap: 5px;
        flex-wrap: wrap;
        max-height: 120px;
        overflow-y: auto;
        width: 100%;
        padding: 0 20px;
      }

      .action-buttons {
        margin-top: 10px;
        text-align: center;
      }

      button {
        margin: 5px;
        padding: 8px 16px;
        font-size: 0.9rem;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background: #7db6e8;
        color: white;
        transition: background 0.3s;
      }

      button:hover {
        background: #5a9ed6;
      }

      button:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }

      #hintMessage {
        color: red;
        font-weight: bold;
        margin-top: 5px;
        font-size: 0.8rem;
      }

      .action-log {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 250px;
        max-height: 200px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        font-size: 0.8rem;
        z-index: 10;
      }

      .log-entry {
        margin: 3px 0;
        padding: 3px;
        border-radius: 3px;
        font-size: 0.75rem;
      }

      .log-entry.ai {
        background: #e3f2fd;
      }

      .log-entry.player {
        background: #f3e5f5;
      }

      .log-entry.system {
        background: #fff3cd;
      }

      .log-entry.error {
        background: #ffebee;
        color: #c62828;
      }

      .log-entry.ai-phrase {
        background: #e8f5e8;
        color: #2e7d32;
        font-style: italic;
        border-left: 3px solid #4caf50;
      }

      .direction-indicator {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: bold;
        color: #2196f3;
        border: 2px solid #2196f3;
        z-index: 10;
      }

      /* --- Cleaned Up Speech Bubble Styles --- */
      .speech-bubble {
        position: absolute;
        background: white;
        border: 2px solid #7db6e8;
        border-radius: 15px;
        padding: 8px 12px;
        font-size: 0.95rem;
        font-family: "Quicksand", "Nunito", "Baloo", "Comic Sans MS",
          "Comic Sans", "Chalkboard", "cursive", sans-serif;
        min-width: 140px;
        max-width: 320px;
        white-space: pre-line;
        word-break: break-word;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.3s ease;
        pointer-events: none;
        text-align: center;
        overflow: visible;
      }
      .speech-bubble.show {
        opacity: 1;
        transform: scale(1);
      }
      /* --- Move Speech Bubbles Closer to AI Boxes --- */
      .speech-bubble.ai-1 {
        left: 50%;
        top: auto;
        bottom: 100%;
        transform: translateX(-50%) translateY(-8px);
        margin-bottom: 0;
        margin-top: 0;
        z-index: 101;
      }
      .speech-bubble.ai-1::after {
        content: "";
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 16px solid #7db6e8;
      }
      .speech-bubble.ai-1::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%) translateY(-2px);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 14px solid white;
      }
      .speech-bubble.ai-2 {
        left: 50%;
        top: 100%;
        transform: translateX(-50%) translateY(8px);
        margin-top: 0;
        z-index: 101;
      }
      .speech-bubble.ai-2::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: 100%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 16px solid #7db6e8;
      }
      .speech-bubble.ai-2::before {
        content: "";
        position: absolute;
        left: 50%;
        bottom: 100%;
        transform: translateX(-50%) translateY(2px);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 14px solid white;
      }
      .speech-bubble.ai-3 {
        left: 50%;
        top: auto;
        bottom: 100%;
        transform: translateX(-50%) translateY(-8px);
        margin-bottom: 0;
        margin-top: 0;
        z-index: 101;
      }
      .speech-bubble.ai-3::after {
        content: "";
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 16px solid #7db6e8;
      }
      .speech-bubble.ai-3::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%) translateY(-2px);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 14px solid white;
      }
      /* Prevent overlap with pile and log by increasing vertical offset and max-width */
      @media (min-width: 601px) {
        .speech-bubble.ai-1,
        .speech-bubble.ai-3 {
          max-width: 220px;
          transform: translateX(-50%) translateY(-8px);
        }
        .speech-bubble.ai-2 {
          max-width: 220px;
          transform: translateX(-50%) translateY(8px);
        }
      }
      /* Responsive: shrink bubbles and margins on small screens */
      @media (max-width: 600px) {
        .speech-bubble.ai-1,
        .speech-bubble.ai-3 {
          max-width: 140px;
          transform: translateX(-50%) translateY(-8px);
        }
        .speech-bubble.ai-2 {
          max-width: 140px;
          transform: translateX(-50%) translateY(8px);
        }
      }
      /* Ensure all parent containers allow overflow */
      .game-container,
      .game-board,
      .ai-player {
        overflow: visible !important;
      }

      /* Ensure highlight always applies */
      .ai-player.ai-1.active,
      .ai-player.ai-2.active,
      .ai-player.ai-3.active {
        border-color: #7db6e8 !important;
        background: rgba(125, 182, 232, 0.15) !important;
        box-shadow: 0 0 15px rgba(125, 182, 232, 0.3) !important;
      }
      button.highlight-draw {
        background: #ffeb3b !important;
        color: #333 !important;
        border: 2px solid #fbc02d !important;
        animation: pulse-draw 1s infinite alternate;
      }
      @keyframes pulse-draw {
        0% {
          box-shadow: 0 0 0 0 #fbc02d;
        }
        100% {
          box-shadow: 0 0 12px 4px #ffe082;
        }
      }
      /* On small screens, push bubbles even further */
      @media (max-width: 600px) {
        .speech-bubble.ai-1,
        .speech-bubble.ai-3 {
          bottom: calc(100% + 140px);
        }
        .speech-bubble.ai-2 {
          top: calc(100% + 140px);
        }
      }

      /* Change Card Modal Styles */
      #changeModal {
        display: none;
        position: fixed;
        z-index: 20000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        justify-content: center;
        align-items: center;
      }
      #changeModal .modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 32px 24px 24px 24px;
        box-shadow: 0 8px 32px rgba(33, 150, 243, 0.18);
        min-width: 280px;
        max-width: 90vw;
        text-align: center;
      }
      #changeModal label {
        display: block;
        margin: 12px 0 4px 0;
        font-weight: bold;
      }
      #changeModal select {
        margin-bottom: 16px;
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #7db6e8;
        font-size: 1rem;
      }
      #changeModal button {
        margin-top: 12px;
        padding: 8px 20px;
        border-radius: 6px;
        border: none;
        background: #7db6e8;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
      }
      #changeModal button:hover {
        background: #2196f3;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <div class="direction-indicator" id="directionIndicator">↻ Clockwise</div>
      <div class="game-board">
        <!-- Center Pile -->
        <div class="pile-center" id="pile"></div>

        <!-- AI Players -->
        <div class="ai-player ai-1" id="ai1">
          <div class="speech-bubble ai-1" id="speechBubble1"></div>
          <h3>AI 1</h3>
          <div class="ai-cards" id="ai1Cards"></div>
        </div>

        <div class="ai-player ai-2" id="ai2">
          <div class="speech-bubble ai-2" id="speechBubble2"></div>
          <h3>AI 2</h3>
          <div class="ai-cards" id="ai2Cards"></div>
        </div>

        <div class="ai-player ai-3" id="ai3">
          <div class="speech-bubble ai-3" id="speechBubble3"></div>
          <h3>AI 3</h3>
          <div class="ai-cards" id="ai3Cards"></div>
        </div>
      </div>

      <!-- Human Player moved outside game-board -->
      <div class="human-player" id="humanBox">
        <h2>Your Hand</h2>
        <div class="hand" id="hand"></div>
        <div class="action-buttons">
          <button onclick="drawCard()" id="drawButton">Draw Card</button>
          <button onclick="showHint()" id="hintButton">
            Hint (<span id="hintCount">5</span> left)
          </button>
          <button onclick="window.location.href='index.html'">
            Return to Homepage
          </button>
        </div>
        <div id="hintMessage"></div>
      </div>
      <!-- Action Log -->
      <div class="action-log" id="actionLog"></div>

      <!-- Change Card Modal -->
      <div id="changeModal">
        <div class="modal-content">
          <h2>Choose Articulation</h2>
          <form id="changeForm">
            <div id="changeOptions"></div>
            <button type="submit">Confirm</button>
          </form>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="ipa-deck.js"></script>
    <script src="ai-names.js"></script>
    <script src="wug-phrases.js"></script>
    <script>
      const socket = io();
      const urlParams = new URLSearchParams(window.location.search);
      const currentMode = urlParams.get("mode") || "consonant";
      const currentDifficulty = urlParams.get("difficulty") || "easy";

      let hand = [];
      let pileCard = null;
      let hintRemaining = 5;
      let currentTurn = 0;
      let aiPlayers = [];
      let isMyTurn = false;
      let isPlaying = false;
      let gameStarted = false;
      let gameDirection = 1; // 1 for clockwise, -1 for counterclockwise

      // Track AI card counts
      let aiCardCounts = { ai_1: 7, ai_2: 7, ai_3: 7 };

      // Use aiNameList from ai-names.js for AI names
      let aiNames = [];

      // Join a game room
      const roomId = "room1";
      socket.emit("joinGame", roomId, currentMode, currentDifficulty);

      socket.on("startGame", (data) => {
        console.log("Game started:", data);
        hand = data.hand;
        pileCard = data.pileCard;
        aiPlayers = data.aiPlayers;
        currentTurn = data.turn;
        gameStarted = true;

        isMyTurn = currentTurn === 0;
        isPlaying = false;
        // Assign AI names from aiNameList (shuffle if more than 3)
        if (window.aiNameList && window.aiNameList.length >= 3) {
          const shuffled = window.aiNameList
            .slice()
            .sort(() => 0.5 - Math.random());
          aiNames = [shuffled[0], shuffled[1], shuffled[2]];
        } else {
          aiNames = ["Bibi", "Sass", "Mimi"];
        }
        render();
        updateTurnIndicator();
        addLogEntry(
          "Game started! You are playing against 3 wugs 🐤.",
          "system"
        );
      });

      socket.on("aiThinking", (data) => {
        console.log("AI thinking:", data);

        // Handle AI phrase during thinking phase
        if (data.phrase) {
          const phrase = getAIPlayPhrase(
            data.phrase.wugKey,
            data.phrase.card,
            data.phrase.mode
          );
          if (phrase) {
            const aiIndex = parseInt(data.playerId.split("_")[1]) - 1;
            const aiName = aiNames[aiIndex] || "Wug";

            // Show speech bubble
            showSpeechBubble(aiIndex + 1, phrase);

            // Also add to log
            addLogEntry(`${aiName}: "${phrase}"`, "ai-phrase");
          }
        }
      });

      socket.on("cardPlayed", (data) => {
        console.log("Card played:", data);
        pileCard = data.card;

        if (data.playerId === socket.id) {
          const message = data.isReverse
            ? `You played ${data.card.symbol} (REVERSE!)`
            : `You played ${data.card.symbol}`;
          addLogEntry(message, "player");
        } else {
          const aiIndex = parseInt(data.playerId.split("_")[1]) - 1;
          const aiName = aiNames[aiIndex] || "Wug";
          let message;
          if (data.card.isChange) {
            const changeText =
              currentMode === "consonant"
                ? `${data.card.place}, ${data.card.manner}`
                : `${data.card.height}, ${data.card.backness}`;
            message = `${aiName} played ${data.card.symbol} (CHANGE to ${changeText}!)`;
          } else if (data.isReverse) {
            message = `${aiName} played ${data.card.symbol} (REVERSE!)`;
          } else {
            message = `${aiName} played ${data.card.symbol}`;
          }
          addLogEntry(message, "ai");

          // Update AI card count
          aiCardCounts[data.playerId]--;
          console.log(
            `Updated ${data.playerId} card count to:`,
            aiCardCounts[data.playerId]
          );

          // Show AI change card phrase in speech bubble
          if (data.card.isChange) {
            const changeText =
              currentMode === "consonant"
                ? `${data.card.place}, ${data.card.manner}`
                : `${data.card.height}, ${data.card.backness}`;
            showSpeechBubble(aiIndex + 1, `🪄${changeText}🪄`);
            addLogEntry(`${aiName}: "🪄${changeText}🪄"`, "ai-phrase");
          }
        }

        currentTurn = data.turn;
        isMyTurn = currentTurn === 0;
        isPlaying = false;
        // Update direction if a reverse card was played
        if (data.isReverse) {
          gameDirection *= -1;
          updateDirectionIndicator();
        }
        render();
        updateTurnIndicator();
      });

      socket.on("cardDrawn", (data) => {
        console.log("Card drawn:", data);

        if (data.playerId === socket.id) {
          addLogEntry("You drew a card", "player");
        } else {
          const aiIndex = parseInt(data.playerId.split("_")[1]) - 1;
          const aiName = aiNames[aiIndex] || "Wug";
          addLogEntry(`${aiName} drew a card`, "ai");
          // Update AI card count
          aiCardCounts[data.playerId]++;
          // Show AI draw phrase in speech bubble
          if (typeof getAIDrawPhrase === "function") {
            const phrase = getAIDrawPhrase(aiName);
            showSpeechBubble(aiIndex + 1, phrase);
            addLogEntry(`${aiName}: "${phrase}"`, "ai-phrase");
          }
        }

        currentTurn = data.turn;
        isMyTurn = currentTurn === 0;
        isPlaying = false;
        render();
        updateTurnIndicator();
        // drawButton will be re-enabled in render() if isMyTurn
      });

      socket.on("updateHand", (data) => {
        console.log("Hand updated:", data.hand);
        hand = data.hand;
        render();
      });

      socket.on("turnUpdate", (data) => {
        console.log("Turn updated:", data);
        currentTurn = data.turn;
        isMyTurn = currentTurn === 0;
        isPlaying = false;
        updateTurnIndicator();
        render();
      });

      socket.on("gameOver", (data) => {
        const winner = data.winner === socket.id ? "You" : `AI ${data.winner}`;
        addLogEntry(`Game Over! ${winner} won!`, "system");
        document.getElementById(
          "gameStatus"
        ).textContent = `Game Over! ${winner} won!`;
        document.getElementById("drawButton").disabled = true;
        document.getElementById("hintButton").disabled = true;
      });

      socket.on("error", (data) => {
        addLogEntry(`Error: ${data.message}`, "error");
      });

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      function render(showHints = false) {
        renderHand(showHints);
        renderPile();
        renderAIPlayers();
        // Re-enable draw button if it was disabled and it's my turn
        if (document.getElementById("drawButton").disabled && isMyTurn) {
          document.getElementById("drawButton").disabled = false;
        }
        // Re-enable hint button if it was disabled, it's my turn, and hints remain
        if (
          document.getElementById("hintButton").disabled &&
          isMyTurn &&
          hintRemaining > 0
        ) {
          document.getElementById("hintButton").disabled = false;
        }
      }

      function renderHand(showHints = false) {
        console.log("renderHand", isMyTurn, currentTurn);

        const handDiv = document.getElementById("hand");
        const hintMessage = document.getElementById("hintMessage");
        const hintCount = document.getElementById("hintCount");
        handDiv.innerHTML = "";
        if (hintMessage) hintMessage.textContent = "";
        let anyHints = false;
        let hasPlayable = false;

        if (hand.length === 0) {
          const loadingDiv = document.createElement("div");
          loadingDiv.innerHTML = "<p>Loading cards...</p>";
          handDiv.appendChild(loadingDiv);
          return;
        }

        hand.forEach((card, index) => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `<div>${card.symbol}</div>`;
          if (currentDifficulty === "easy") {
            div.innerHTML += `<span class="card-label">${
              currentMode === "consonant"
                ? card.place + ", " + card.manner
                : card.height + ", " + card.backness
            }</span>`;
          }

          // Add reverse class if it's a reverse card
          if (card.isReverse) {
            div.classList.add("reverse");
          }

          if (isMatch(card, pileCard)) {
            hasPlayable = true;
          }
          if (showHints && isMatch(card, pileCard)) {
            div.classList.add("hint");
            anyHints = true;
          }
          if (isMyTurn) {
            div.onclick = () => playCard(index);
          }
          handDiv.appendChild(div);
        });

        const drawButton = document.getElementById("drawButton");
        if (showHints && !anyHints) {
          if (hintMessage)
            hintMessage.textContent =
              "No playable cards. Please draw a new one.";
          drawButton.classList.add("highlight-draw");
          addLogEntry("No playable card, draw a new card!", "system");
        } else {
          drawButton.classList.remove("highlight-draw");
        }
        if (hintCount) hintCount.textContent = hintRemaining;
      }

      function renderPile() {
        const pileDiv = document.getElementById("pile");
        pileDiv.innerHTML = "";

        if (pileCard) {
          const div = document.createElement("div");
          div.className = "card pile-card";

          // Special display for change cards
          if (pileCard.isChange) {
            let changeText = "";
            if (currentMode === "consonant") {
              changeText = `${pileCard.place}, ${pileCard.manner}`;
            } else {
              changeText = `${pileCard.height}, ${pileCard.backness}`;
            }
            div.innerHTML = `<div>🪄${changeText}🪄</div>`;
          } else {
            div.innerHTML = `<div>${pileCard.symbol}</div>`;
          }

          if (currentDifficulty === "easy") {
            div.innerHTML += `<span class="card-label">${
              currentMode === "consonant"
                ? pileCard.place + ", " + pileCard.manner
                : pileCard.height + ", " + pileCard.backness
            }</span>`;
          }

          // Add reverse class if it's a reverse card
          if (pileCard.isReverse) {
            div.classList.add("reverse");
          }

          pileDiv.appendChild(div);
        }
      }

      function renderAIPlayers() {
        console.log("renderAIPlayers: currentTurn =", currentTurn);
        // Update AI 1 (left)
        const ai1 = document.getElementById("ai1");
        const ai1Cards = document.getElementById("ai1Cards");
        ai1Cards.innerHTML = "";
        for (let i = 0; i < aiCardCounts.ai_1; i++) {
          const cardDiv = document.createElement("div");
          cardDiv.className = "ai-card back";
          // No question mark, just the Wug image
          ai1Cards.appendChild(cardDiv);
        }
        ai1.querySelector("h3").textContent = aiNames[0] || "Bibi";
        // Update AI 2 (top)
        const ai2 = document.getElementById("ai2");
        const ai2Cards = document.getElementById("ai2Cards");
        ai2Cards.innerHTML = "";
        for (let i = 0; i < aiCardCounts.ai_2; i++) {
          const cardDiv = document.createElement("div");
          cardDiv.className = "ai-card back";
          // No question mark, just the Wug image
          ai2Cards.appendChild(cardDiv);
        }
        ai2.querySelector("h3").textContent = aiNames[1] || "Sass";
        // Update AI 3 (right)
        const ai3 = document.getElementById("ai3");
        const ai3Cards = document.getElementById("ai3Cards");
        ai3Cards.innerHTML = "";
        for (let i = 0; i < aiCardCounts.ai_3; i++) {
          const cardDiv = document.createElement("div");
          cardDiv.className = "ai-card back";
          // No question mark, just the Wug image
          ai3Cards.appendChild(cardDiv);
        }
        ai3.querySelector("h3").textContent = aiNames[2] || "Mimi";
        // Update active states
        ai1.className = "ai-player ai-1" + (currentTurn === 1 ? " active" : "");
        ai2.className = "ai-player ai-2" + (currentTurn === 2 ? " active" : "");
        ai3.className = "ai-player ai-3" + (currentTurn === 3 ? " active" : "");
        if (currentTurn === 1) console.log("AI 1 highlighted");
        if (currentTurn === 2) console.log("AI 2 highlighted");
        if (currentTurn === 3) {
          console.log("AI 3 highlighted");
          console.log("AI 3 className:", ai3.className);
          console.log("AI 3 card count:", aiCardCounts.ai_3);
        }
        // Human highlight
        const humanBox = document.getElementById("humanBox");
        humanBox.className = `human-player${
          currentTurn === 0 ? " active" : ""
        }`;
      }

      function updateTurnIndicator() {
        // No-op: turn indicator has been removed from the UI
      }

      function updateDirectionIndicator() {
        const indicator = document.getElementById("directionIndicator");
        if (indicator) {
          if (gameDirection === 1) {
            indicator.textContent = "↻ Clockwise";
            indicator.style.color = "#2196f3";
            indicator.style.borderColor = "#2196f3";
          } else {
            indicator.textContent = "↺ Counterclockwise";
            indicator.style.color = "#ff5722";
            indicator.style.borderColor = "#ff5722";
          }
        }
      }

      function addLogEntry(message, type) {
        const logDiv = document.getElementById("actionLog");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function showSpeechBubble(aiNumber, message) {
        const bubble = document.getElementById(`speechBubble${aiNumber}`);
        if (bubble) {
          bubble.textContent = message;
          bubble.classList.add("show");

          // Hide the bubble after 5 seconds (longer since game is much slower)
          setTimeout(() => {
            bubble.classList.remove("show");
          }, 5000);
        }
      }

      function playCard(index) {
        if (!isMyTurn || isPlaying) {
          addLogEntry("Not your turn!", "error");
          return;
        }
        isPlaying = true;
        isMyTurn = false; // Immediately prevent further plays
        document.getElementById("drawButton").disabled = true;
        document.getElementById("hintButton").disabled = true;
        render(); // This will re-render the hand with no click handlers

        const card = hand[index];
        // Intercept change card (🪄)
        if (card.isChange) {
          showChangeModal(card, index);
          return;
        }
        if (isMatch(card, pileCard)) {
          socket.emit("playCard", { roomId, cardIndex: index });
        } else {
          addLogEntry("Card does not match!", "error");
          // Allow player to try again:
          isMyTurn = true;
          isPlaying = false;
          document.getElementById("drawButton").disabled = false;
          if (hintRemaining > 0)
            document.getElementById("hintButton").disabled = false;
          render();
        }
      }

      // Show the change card modal
      function showChangeModal(card, cardIndex) {
        const modal = document.getElementById("changeModal");
        const optionsDiv = document.getElementById("changeOptions");
        optionsDiv.innerHTML = "";
        // Determine mode
        if (currentMode === "consonant") {
          // Place
          const placeLabel = document.createElement("label");
          placeLabel.textContent = "Place of Articulation";
          placeLabel.setAttribute("for", "changePlace");
          optionsDiv.appendChild(placeLabel);
          const placeSelect = document.createElement("select");
          placeSelect.id = "changePlace";
          [
            "bilabial",
            "labiodental",
            "dental",
            "alveolar",
            "postalveolar",
            "retroflex",
            "palatal",
            "velar",
            "uvular",
            "pharyngeal",
            "glottal",
          ].forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p.charAt(0).toUpperCase() + p.slice(1);
            placeSelect.appendChild(opt);
          });
          optionsDiv.appendChild(placeSelect);
          // Manner
          const mannerLabel = document.createElement("label");
          mannerLabel.textContent = "Manner of Articulation";
          mannerLabel.setAttribute("for", "changeManner");
          optionsDiv.appendChild(mannerLabel);
          const mannerSelect = document.createElement("select");
          mannerSelect.id = "changeManner";
          [
            "plosive",
            "nasal",
            "trill",
            "tap",
            "fricative",
            "affricate",
            "approximant",
            "lateral approximant",
          ].forEach((m) => {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m.charAt(0).toUpperCase() + m.slice(1);
            mannerSelect.appendChild(opt);
          });
          optionsDiv.appendChild(mannerSelect);
        } else {
          // Vowel mode: Height and Backness
          const heightLabel = document.createElement("label");
          heightLabel.textContent = "Height";
          heightLabel.setAttribute("for", "changeHeight");
          optionsDiv.appendChild(heightLabel);
          const heightSelect = document.createElement("select");
          heightSelect.id = "changeHeight";
          [
            "close",
            "near-close",
            "close-mid",
            "mid",
            "open-mid",
            "near-open",
            "open",
          ].forEach((h) => {
            const opt = document.createElement("option");
            opt.value = h;
            opt.textContent = h.charAt(0).toUpperCase() + h.slice(1);
            heightSelect.appendChild(opt);
          });
          optionsDiv.appendChild(heightSelect);
          const backLabel = document.createElement("label");
          backLabel.textContent = "Backness";
          backLabel.setAttribute("for", "changeBackness");
          optionsDiv.appendChild(backLabel);
          const backSelect = document.createElement("select");
          backSelect.id = "changeBackness";
          ["front", "central", "back"].forEach((b) => {
            const opt = document.createElement("option");
            opt.value = b;
            opt.textContent = b.charAt(0).toUpperCase() + b.slice(1);
            backSelect.appendChild(opt);
          });
          optionsDiv.appendChild(backSelect);
        }
        modal.style.display = "flex";
        // Handle form submit
        const form = document.getElementById("changeForm");
        form.onsubmit = function (e) {
          e.preventDefault();
          let payload = { roomId, cardIndex };
          if (currentMode === "consonant") {
            payload.changePlace = document.getElementById("changePlace").value;
            payload.changeManner =
              document.getElementById("changeManner").value;
          } else {
            payload.changeHeight =
              document.getElementById("changeHeight").value;
            payload.changeBackness =
              document.getElementById("changeBackness").value;
          }
          modal.style.display = "none";
          socket.emit("playCard", payload);
        };
      }

      function drawCard() {
        if (!isMyTurn) {
          addLogEntry("Not your turn!", "error");
          return;
        }
        document.getElementById("drawButton").disabled = true;
        document.getElementById("hintButton").disabled = true;
        isMyTurn = false;
        socket.emit("drawCard", { roomId });
      }

      function showHint() {
        if (!isMyTurn || hintRemaining <= 0) return;
        socket.emit("showHint");
        hintRemaining--;
        document.getElementById(
          "hintButton"
        ).textContent = `Hint (${hintRemaining} left)`;
        addLogEntry("You used a hint", "player");
        // Do not disable drawButton after hint
        render(true);
      }

      function isMatch(card, pileCard) {
        if (!pileCard) return true; // If no pile card, any card is playable
        if (card.symbol === pileCard.symbol) return true;
        if (card.symbol === "W" && pileCard.symbol === "U") return true;
        if (card.symbol === "U" && pileCard.symbol === "W") return true;
        // Reverse cards can be played on any card
        if (card.isReverse || pileCard.isReverse) return true;
        return card.place === pileCard.place || card.manner === pileCard.manner;
      }

      // Initial render to set up the game board and hand
      render();
    </script>
  </body>
</html>
