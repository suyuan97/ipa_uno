<!-- File: game.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IPA UNO - Game</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Rubik:wght@400&display=swap");
      body {
        font-family: sans-serif;
        background: #fff;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: visible;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: visible;
      }
      .game-container {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: visible;
      }

      /* Remove the header panel */
      .game-header {
        display: none !important;
      }

      .game-board {
        flex: 1 1 auto;
        height: auto;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        min-height: 500px;
        background: none;
        overflow: visible;
      }

      .human-player {
        position: relative;
        bottom: 0;
        left: 0;
        right: 0;
        text-align: center;
        background: #f6faff;
        padding: 15px 0 10px 0;
        box-shadow: 0 -4px 16px rgba(125, 182, 232, 0.12);
        border: none;
        transition: box-shadow 0.3s;
        z-index: 10;
      }
      .human-player.active {
        box-shadow: 0 -4px 24px 0 rgba(125, 182, 232, 0.25);
        background: rgba(125, 182, 232, 0.08);
      }

      .pile-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 120px;
        height: 160px;
        /* Ensures enough space for the card to be centered */
      }

      .card {
        display: inline-block;
        margin: 5px;
        padding: 15px 20px;
        border: 2px solid #444;
        border-radius: 12px;
        cursor: default;
        font-size: 1.5rem;
        min-width: 60px;
        max-width: 80px;
        background-color: white;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      .pile-card {
        margin: 0 auto;
        box-shadow: 0 0 0 6px #7db6e8, 0 8px 32px 0 rgba(33, 150, 243, 0.45),
          0 2px 16px 0 rgba(0, 0, 0, 0.25);
        z-index: 10;
        position: relative;
        animation: pop-pile-card 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        text-align: center;
        word-break: break-word;
        white-space: normal;
        overflow-wrap: anywhere;
        max-width: 100%;
        box-sizing: border-box;
      }

      @keyframes pop-pile-card {
        0% {
          transform: scale(0.7);
          opacity: 0.5;
        }
        80% {
          transform: scale(1.1);
          opacity: 1;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
      }

      .card-label {
        display: block;
        font-size: 0.7rem;
        margin-top: 5px;
        text-align: center;
      }

      .hint {
        background-color: yellow !important;
      }

      .reverse {
        background: #fff9c4 !important;
        border-color: #fbc02d !important;
        color: #333 !important;
        font-weight: bold !important;
        box-shadow: 0 2px 12px #fbc02d33;
      }

      .plus-two {
        background: #e57373 !important;
        border-color: #b71c1c !important;
        color: white !important;
        font-weight: bold !important;
        box-shadow: 0 2px 12px #b71c1c33;
      }

      @keyframes reverse-glow {
        from {
          box-shadow: 0 0 5px rgba(255, 87, 34, 0.5);
        }
        to {
          box-shadow: 0 0 20px rgba(255, 87, 34, 0.8),
            0 0 30px rgba(233, 30, 99, 0.6);
        }
      }

      @keyframes plus-two-glow {
        from {
          box-shadow: 0 0 5px rgba(244, 67, 54, 0.5);
        }
        to {
          box-shadow: 0 0 20px rgba(244, 67, 54, 0.8),
            0 0 30px rgba(211, 47, 47, 0.6);
        }
      }

      .plus-four {
        background: linear-gradient(
          135deg,
          #ff0000 0%,
          #ff9900 20%,
          #ffff00 40%,
          #33cc33 60%,
          #3399ff 80%,
          #9900cc 100%
        ) !important;
        border-color: #333 !important;
        color: white !important;
        font-weight: bold !important;
        animation: plus-four-glow 2s ease-in-out infinite alternate;
      }
      @keyframes plus-four-glow {
        from {
          box-shadow: 0 0 5px rgba(255, 0, 255, 0.5);
        }
        to {
          box-shadow: 0 0 20px rgba(255, 0, 255, 0.8),
            0 0 30px rgba(255, 255, 0, 0.6);
        }
      }

      .ai-player {
        position: absolute;
        padding: 10px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 10px;
        border: 2px solid #ccc;
        text-align: center;
        min-width: 120px;
        overflow: visible;
      }

      .ai-player h3 {
        margin: 0 0 10px 0;
        font-size: 1rem;
      }

      .ai-cards {
        display: flex;
        justify-content: center;
        gap: 3px;
        flex-wrap: wrap;
      }

      .ai-card {
        width: 30px;
        height: 45px;
        background: #2196f3;
        border: 2px solid #1976d2;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.9rem;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .ai-card.back {
        background: #7db6e8 url("wug.png") center center/contain no-repeat;
        border-color: #7db6e8;
      }

      .ai-card.played {
        opacity: 0.3;
        transform: scale(0.8);
      }

      /* AI Player Positions */
      .ai-player.ai-1 {
        left: 20px;
        top: 50%;
        transform: translateY(-50%);
      }

      .ai-player.ai-2 {
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
      }

      .ai-player.ai-3 {
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
      }

      .human-player {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        text-align: center;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-top: 2px solid #4caf50;
      }

      .human-player h2 {
        margin: 0 0 10px 0;
        font-size: 1.2rem;
      }

      .hand {
        display: flex;
        justify-content: center;
        gap: 5px;
        flex-wrap: nowrap;
        max-height: 120px;
        overflow-x: auto;
        overflow-y: hidden;
        width: 100%;
        padding: 0 20px;
        position: relative;
        transition: gap 0.3s;
      }
      /* Overlapping cards for large hands */
      .hand.overlap {
        gap: 0px;
      }
      .hand.overlap .card {
        margin-left: -32px;
        z-index: 1;
        position: relative;
        flex-shrink: 0;
      }
      .hand.overlap .card:first-child {
        margin-left: 0;
      }

      .action-buttons {
        margin-top: 10px;
        text-align: center;
      }

      button {
        margin: 5px;
        padding: 8px 16px;
        font-size: 0.9rem;
        cursor: pointer;
        border: none;
        border-radius: 5px;
        background: #7db6e8;
        color: white;
        transition: background 0.3s;
      }

      button:hover {
        background: #5a9ed6;
      }

      button:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }

      #hintMessage {
        color: red;
        font-weight: bold;
        margin-top: 5px;
        font-size: 0.8rem;
      }

      .action-log {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 250px;
        max-height: 200px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 10px;
        font-size: 0.8rem;
        z-index: 10;
      }

      .log-entry {
        margin: 3px 0;
        padding: 3px;
        border-radius: 3px;
        font-size: 0.75rem;
      }

      .log-entry.ai {
        background: #e3f2fd;
      }

      .log-entry.player {
        background: #f3e5f5;
      }

      .log-entry.system {
        background: #fff3cd;
      }

      .log-entry.error {
        background: #ffebee;
        color: #c62828;
      }

      .log-entry.ai-phrase {
        background: #e8f5e8;
        color: #2e7d32;
        font-style: italic;
        border-left: 3px solid #4caf50;
      }

      .log-entry.uno {
        background: #ffebee;
        color: #c62828;
        font-weight: bold;
        border-left: 3px solid #ff6b6b;
        animation: uno-glow 1s ease-in-out;
      }

      @keyframes uno-glow {
        0% {
          box-shadow: 0 0 5px #ff6b6b;
        }
        50% {
          box-shadow: 0 0 20px #ff6b6b, 0 0 30px #ff6b6b;
        }
        100% {
          box-shadow: 0 0 5px #ff6b6b;
        }
      }

      .log-entry.catch {
        background: #fff3e0;
        color: #e65100;
        font-weight: bold;
        border-left: 3px solid #ff9800;
        animation: catch-glow 1s ease-in-out;
      }

      @keyframes catch-glow {
        0% {
          box-shadow: 0 0 5px #ff9800;
        }
        50% {
          box-shadow: 0 0 20px #ff9800, 0 0 30px #ff9800;
        }
        100% {
          box-shadow: 0 0 5px #ff9800;
        }
      }

      .direction-indicator {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: bold;
        color: #2196f3;
        border: 2px solid #2196f3;
        z-index: 10;
      }

      /* --- Cleaned Up Speech Bubble Styles --- */
      .speech-bubble {
        position: absolute;
        background: white;
        border: 2px solid #7db6e8;
        border-radius: 15px;
        padding: 8px 12px;
        font-size: 0.95rem;
        font-family: "Quicksand", "Nunito", "Baloo", "Comic Sans MS",
          "Comic Sans", "Chalkboard", "cursive", sans-serif;
        min-width: 140px;
        max-width: 320px;
        white-space: pre-line;
        word-break: break-word;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        opacity: 0;
        transform: scale(0.8);
        transition: all 0.3s ease;
        pointer-events: none;
        text-align: center;
        overflow: visible;
      }
      .speech-bubble.show {
        opacity: 1;
        transform: scale(1);
      }
      /* --- Move Speech Bubbles Closer to AI Boxes --- */
      .speech-bubble.ai-1 {
        left: 50%;
        top: auto;
        bottom: 100%;
        transform: translateX(-50%) translateY(-8px);
        margin-bottom: 0;
        margin-top: 0;
        z-index: 101;
      }
      .speech-bubble.ai-1::after {
        content: "";
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 16px solid #7db6e8;
      }
      .speech-bubble.ai-1::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%) translateY(-2px);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 14px solid white;
      }
      .speech-bubble.ai-2 {
        left: 50%;
        top: 100%;
        transform: translateX(-50%) translateY(8px);
        margin-top: 0;
        z-index: 101;
      }
      .speech-bubble.ai-2::after {
        content: "";
        position: absolute;
        left: 50%;
        bottom: 100%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 16px solid #7db6e8;
      }
      .speech-bubble.ai-2::before {
        content: "";
        position: absolute;
        left: 50%;
        bottom: 100%;
        transform: translateX(-50%) translateY(2px);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 14px solid white;
      }
      .speech-bubble.ai-3 {
        left: 50%;
        top: auto;
        bottom: 100%;
        transform: translateX(-50%) translateY(-8px);
        margin-bottom: 0;
        margin-top: 0;
        z-index: 101;
      }
      .speech-bubble.ai-3::after {
        content: "";
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 16px solid #7db6e8;
      }
      .speech-bubble.ai-3::before {
        content: "";
        position: absolute;
        left: 50%;
        top: 100%;
        transform: translateX(-50%) translateY(-2px);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 14px solid white;
      }
      /* Prevent overlap with pile and log by increasing vertical offset and max-width */
      @media (min-width: 601px) {
        .speech-bubble.ai-1,
        .speech-bubble.ai-3 {
          max-width: 220px;
          transform: translateX(-50%) translateY(-8px);
        }
        .speech-bubble.ai-2 {
          max-width: 220px;
          transform: translateX(-50%) translateY(8px);
        }
      }
      /* Responsive: shrink bubbles and margins on small screens */
      @media (max-width: 600px) {
        .speech-bubble.ai-1,
        .speech-bubble.ai-3 {
          max-width: 140px;
          transform: translateX(-50%) translateY(-8px);
        }
        .speech-bubble.ai-2 {
          max-width: 140px;
          transform: translateX(-50%) translateY(8px);
        }
      }
      /* Ensure all parent containers allow overflow */
      .game-container,
      .game-board,
      .ai-player {
        overflow: visible !important;
      }

      /* Ensure highlight always applies */
      .ai-player.ai-1.active,
      .ai-player.ai-2.active,
      .ai-player.ai-3.active {
        border-color: #7db6e8 !important;
        background: rgba(125, 182, 232, 0.15) !important;
        box-shadow: 0 0 15px rgba(125, 182, 232, 0.3) !important;
      }
      button.highlight-draw {
        background: #ffeb3b !important;
        color: #333 !important;
        border: 2px solid #fbc02d !important;
        animation: pulse-draw 1s infinite alternate;
      }
      @keyframes pulse-draw {
        0% {
          box-shadow: 0 0 0 0 #fbc02d;
        }
        100% {
          box-shadow: 0 0 12px 4px #ffe082;
        }
      }
      /* On small screens, push bubbles even further */
      @media (max-width: 600px) {
        .speech-bubble.ai-1,
        .speech-bubble.ai-3 {
          bottom: calc(100% + 140px);
        }
        .speech-bubble.ai-2 {
          top: calc(100% + 140px);
        }
      }

      /* Add this CSS to the <style> section or your stylesheet: */
      .uno-highlight {
        box-shadow: 0 0 16px 6px #ff69b4, 0 0 0 4px #fff;
        border: 2px solid #ff69b4 !important;
        transition: box-shadow 0.2s, border 0.2s;
      }

      /* Change Card Modal Styles */
      #changeModal {
        display: none;
        position: fixed;
        z-index: 20000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        justify-content: center;
        align-items: center;
      }
      #changeModal .modal-content {
        background: #fff;
        border-radius: 12px;
        padding: 32px 24px 24px 24px;
        box-shadow: 0 8px 32px rgba(33, 150, 243, 0.18);
        min-width: 280px;
        max-width: 90vw;
        text-align: center;
      }
      #changeModal label {
        display: block;
        margin: 12px 0 4px 0;
        font-weight: bold;
      }
      #changeModal select {
        margin-bottom: 16px;
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #7db6e8;
        font-size: 1rem;
      }
      #changeModal button {
        margin-top: 12px;
        padding: 8px 20px;
        border-radius: 6px;
        border: none;
        background: #7db6e8;
        color: #fff;
        font-size: 1rem;
        cursor: pointer;
      }
      #changeModal button:hover {
        background: #2196f3;
      }
      .skip {
        background: #eeeeee !important;
        border-color: #616161 !important;
        color: white !important;
        font-weight: bold !important;
        box-shadow: 0 2px 12px #42424233;
      }
      @keyframes skip-glow {
        from {
          box-shadow: 0 0 5px #ff5252;
        }
        to {
          box-shadow: 0 0 20px #ffb300, 0 0 30px #ff5252;
        }
      }
      #helpButton {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        background: transparent;
        border: none;
        color: #bdbdbd;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: background 0.2s, color 0.2s;
        padding: 0;
        background-image: url("icon/question.png");
        background-size: 24px 24px;
        background-position: center;
        background-repeat: no-repeat;
      }
      #helpButton:hover {
        background-color: rgba(224, 224, 224, 0.3);
        background-image: url("icon/question.png");
      }
      #helpButton svg {
        width: 24px;
        height: 24px;
        display: block;
        margin: auto;
        fill: #bdbdbd;
      }
      #helpButton:hover {
        background: #e0e0e0;
        color: #888;
      }
      #helpButton:hover svg {
        fill: #888;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        overflow: auto;
        background: rgba(0, 0, 0, 0.3);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #fff;
        margin: auto;
        padding: 24px 32px;
        border-radius: 12px;
        max-width: 400px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
        position: relative;
        text-align: left;
        font-family: "Rubik", Arial, sans-serif;
      }
      .modal-content h2 {
        margin-top: 0;
        font-size: 1.3em;
        color: #2196f3;
        font-family: "Rubik", Arial, sans-serif;
        font-weight: bold;
      }
      .modal-content ul {
        padding-left: 20px;
        margin: 0;
        font-size: 1em;
        font-family: "Rubik", Arial, sans-serif;
      }
      .modal-content li {
        font-family: "Rubik", Arial, sans-serif;
        font-size: 0.98rem;
        color: #1a237e;
        font-weight: 400;
        letter-spacing: 0.1px;
        margin-bottom: 8px;
      }
      .modal-content .bug-report {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #e0e0e0;
        font-family: "Rubik", Arial, sans-serif;
        font-size: 0.85rem;
        color: #666;
        text-align: center;
      }
      .modal-content .bug-report a {
        color: #2196f3;
        text-decoration: none;
        font-weight: 500;
      }
      .modal-content .bug-report a:hover {
        text-decoration: underline;
      }
      .close {
        position: absolute;
        right: 16px;
        top: 12px;
        font-size: 1.5em;
        color: #888;
        cursor: pointer;
      }
      .close:hover {
        color: #2196f3;
      }
    </style>
  </head>
  <body>
    <button
      id="helpButton"
      title="How to play IPA UNO?"
      aria-label="How to play?"
    ></button>
    <div id="helpModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeHelpModal">&times;</span>
        <h2>How to Play IPA UNO</h2>
        <ul>
          <li>
            Match cards by place or manner (consonants) or height/backness
            (vowels), or play special cards.
          </li>
          <li>Special cards: +2, +4, skip, reverse, change (🪄).</li>
          <li>
            When you have two cards, call UNO before playing your second-to-last
            card!
          </li>
          <li>
            If you forget to call UNO and are caught, you must draw a card.
          </li>
          <li>First to play all cards wins. Have fun with IPA!</li>
        </ul>
        <div class="bug-report">
          Found a bug?
          <a
            href="https://github.com/suyuan97/ipa_uno/issues/new"
            target="_blank"
            >Report it here</a
          >
        </div>
      </div>
    </div>
    <div class="game-container">
      <div class="direction-indicator" id="directionIndicator">↻ Clockwise</div>
      <div class="game-board">
        <!-- Center Pile -->
        <div class="pile-center" id="pile"></div>

        <!-- AI Players -->
        <div class="ai-player ai-1" id="ai1">
          <div class="speech-bubble ai-1" id="speechBubble1"></div>
          <h3>AI 1</h3>
          <div class="ai-cards" id="ai1Cards"></div>
        </div>

        <div class="ai-player ai-2" id="ai2">
          <div class="speech-bubble ai-2" id="speechBubble2"></div>
          <h3>AI 2</h3>
          <div class="ai-cards" id="ai2Cards"></div>
        </div>

        <div class="ai-player ai-3" id="ai3">
          <div class="speech-bubble ai-3" id="speechBubble3"></div>
          <h3>AI 3</h3>
          <div class="ai-cards" id="ai3Cards"></div>
        </div>
      </div>

      <!-- Human Player moved outside game-board -->
      <div class="human-player" id="humanBox">
        <h2>Your Hand</h2>
        <div class="hand" id="hand"></div>
        <div class="action-buttons">
          <button onclick="drawCard()" id="drawButton">Draw Card</button>
          <button onclick="showHint()" id="hintButton">
            Hint (<span id="hintCount">5</span> left)
          </button>
          <button
            onclick="callUno()"
            id="unoButton"
            style="
              background-color: #ffb6c1;
              border-color: #ff69b4;
              color: #333;
            "
          >
            Call UNO!
          </button>
          <button onclick="window.location.href='index.html'">
            Return to Homepage
          </button>
        </div>
        <div id="hintMessage"></div>
      </div>
      <!-- Action Log -->
      <div class="action-log" id="actionLog"></div>

      <!-- Change Card Modal -->
      <div id="changeModal">
        <div class="modal-content">
          <h2>Choose Articulation</h2>
          <form id="changeForm">
            <div id="changeOptions"></div>
            <button type="submit">Confirm</button>
          </form>
        </div>
      </div>
      <div
        id="winnerOverlay"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: rgba(255, 255, 255, 0.95);
          z-index: 99999;
          justify-content: center;
          align-items: center;
          flex-direction: column;
        "
      >
        <div
          class="credits"
          style="
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'Rubik', Arial, sans-serif;
            font-size: 0.8rem;
            color: #1a237e;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 100000;
          "
        >
          This game is built by
          <a
            href="https://suyuan97.github.io/"
            target="_blank"
            style="color: #2196f3; text-decoration: none; font-weight: 500"
            >Suyuan Liu</a
          >
          using Cursor (Claude Sonnet 4). <br />Buy me a ☕️ |
          <a
            href="https://ko-fi.com/syliu"
            target="_blank"
            style="
              color: #ff6b6b;
              text-decoration: none;
              font-weight: 500;
              font-size: 0.75rem;
            "
            >❤️ Support on Ko-fi</a
          >
        </div>
        <canvas
          id="confettiCanvas"
          style="
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
          "
        ></canvas>
        <div style="position: relative; z-index: 2; text-align: center">
          <h1
            id="winnerMessage"
            style="
              font-size: 3rem;
              margin-bottom: 1rem;
              color: #2196f3;
              text-shadow: 0 2px 16px #7db6e8, 0 0 8px #fff;
            "
          >
            Winner!
          </h1>
          <button
            onclick="window.location.href='index.html'"
            style="
              font-size: 1.2rem;
              padding: 12px 32px;
              border-radius: 8px;
              background: #7db6e8;
              color: #fff;
              border: none;
              margin-top: 2rem;
              margin-right: 1rem;
              box-shadow: 0 2px 8px #2196f3;
              cursor: pointer;
            "
          >
            Return to Homepage
          </button>
          <button
            onclick="restartGame()"
            style="
              font-size: 1.2rem;
              padding: 12px 32px;
              border-radius: 8px;
              background: #4caf50;
              color: #fff;
              border: none;
              margin-top: 2rem;
              margin-left: 1rem;
              box-shadow: 0 2px 8px #4caf50;
              cursor: pointer;
            "
          >
            Another Round
          </button>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="ipa-deck.js"></script>
    <script src="ai-names.js"></script>
    <script src="wug-phrases.js"></script>
    <script>
      let catchableAIs = [];
      const socket = io();
      const urlParams = new URLSearchParams(window.location.search);
      const currentMode = urlParams.get("mode") || "consonant";
      const currentDifficulty = urlParams.get("difficulty") || "easy";

      let hand = [];
      let pileCard = null;
      let hintRemaining = 5;
      let currentTurn = 0;
      let aiPlayers = [];
      let isMyTurn = false;
      let isPlaying = false;
      let gameStarted = false;
      let gameDirection = 1; // 1 for clockwise, -1 for counterclockwise
      let restarting = false;

      // Track AI card counts
      let aiCardCounts = { ai_1: 7, ai_2: 7, ai_3: 7 };

      // Use aiNameList from ai-names.js for AI names
      let aiNames = [];

      // Join a game room
      const roomId = "room1";
      socket.emit("joinGame", roomId, currentMode, currentDifficulty);

      socket.on("startGame", (data) => {
        if (restarting) {
          // Hide the winner overlay and reset state only on actual new game
          document.getElementById("winnerOverlay").style.display = "none";
          // Reset game state
          hand = [];
          pileCard = null;
          hintRemaining = 5;
          currentTurn = 0;
          aiPlayers = [];
          isMyTurn = false;
          isPlaying = false;
          gameStarted = false;
          gameDirection = 1;
          aiCardCounts = { ai_1: 7, ai_2: 7, ai_3: 7 };
          aiNames = [];
          // Clear the action log
          document.getElementById("actionLog").innerHTML = "";
          // Re-enable buttons
          document.getElementById("drawButton").disabled = false;
          document.getElementById("hintButton").disabled = false;
          restarting = false;
        }
        console.log("Game started:", data);
        hand = data.hand;
        pileCard = data.pileCard;
        aiPlayers = data.aiPlayers;
        currentTurn = data.turn;
        gameStarted = true;

        isMyTurn = currentTurn === 0;
        isPlaying = false;
        // Assign AI names from aiNameList (shuffle if more than 3)
        if (window.aiNameList && window.aiNameList.length >= 3) {
          const shuffled = window.aiNameList
            .slice()
            .sort(() => 0.5 - Math.random());
          aiNames = [shuffled[0], shuffled[1], shuffled[2]];
        } else {
          aiNames = ["Bibi", "Sass", "Mimi"];
        }
        render();
        updateTurnIndicator();
        addLogEntry(
          "Game started! You are playing against 3 wugs 🐤.",
          "system"
        );
      });

      // Handle game restart (Another Round button)
      socket.on("gameStarted", (data) => {
        console.log("Game restarted:", data);
        // Hide the winner overlay and reset state
        document.getElementById("winnerOverlay").style.display = "none";
        // Clear any existing game state
        hand = [];
        pileCard = null;
        aiPlayers = [];
        currentTurn = 0;
        isMyTurn = true;
        isPlaying = false;
        aiCardCounts = {};
        gameDirection = 1;
        restarting = false;
        hintRemaining = 5;

        hand = data.hand;
        pileCard = data.pileCard;
        aiPlayers = data.aiPlayers;
        currentTurn = data.turn;
        gameStarted = true;

        isMyTurn = currentTurn === 0;
        isPlaying = false;
        // Assign AI names from aiNameList (shuffle if more than 3)
        if (window.aiNameList && window.aiNameList.length >= 3) {
          const shuffled = window.aiNameList
            .slice()
            .sort(() => 0.5 - Math.random());
          aiNames = [shuffled[0], shuffled[1], shuffled[2]];
        } else {
          aiNames = ["Bibi", "Sass", "Mimi"];
        }
        // Clear the action log
        document.getElementById("actionLog").innerHTML = "";
        // Re-enable buttons
        document.getElementById("drawButton").disabled = false;
        document.getElementById("hintButton").disabled = false;
        render();
        updateTurnIndicator();
        addLogEntry(
          "New round started! You are playing against 3 wugs 🐤.",
          "system"
        );
      });

      socket.on("aiThinking", (data) => {
        console.log("AI thinking:", data);

        // Handle AI phrase during thinking phase
        if (data.phrase) {
          const phrase = getAIPlayPhrase(
            data.phrase.wugKey,
            data.phrase.card,
            data.phrase.mode
          );
          if (phrase) {
            const aiIndex = parseInt(data.playerId.split("_")[1]) - 1;
            const aiName = aiNames[aiIndex] || "Wug";

            // Show speech bubble
            showSpeechBubble(aiIndex + 1, phrase);

            // Also add to log
            addLogEntry(`${aiName}: "${phrase}"`, "ai-phrase");
          }
        }
      });

      socket.on("cardPlayed", (data) => {
        console.log("Card played:", data);
        pileCard = data.card;

        if (data.playerId === socket.id) {
          let message;
          if (data.card.isPlusTwo) {
            message = `You played ${data.card.symbol} (+2!)`;
          } else if (data.isReverse) {
            message = `You played ${data.card.symbol} (REVERSE!)`;
          } else if (data.card.isSkip) {
            message = `You played ${data.card.symbol} (SKIP!)`;
          } else {
            message = `You played ${data.card.symbol}`;
          }
          addLogEntry(message, "player");
        } else {
          const aiIndex = parseInt(data.playerId.split("_")[1]) - 1;
          const aiName = aiNames[aiIndex] || "Wug";
          let message;
          if (data.card.isChange) {
            let changeText = "";
            if (currentMode === "consonant") {
              if (
                data.card.place !== "change" &&
                data.card.manner === "change"
              ) {
                changeText = data.card.place;
              } else if (
                data.card.manner !== "change" &&
                data.card.place === "change"
              ) {
                changeText = data.card.manner;
              }
            } else {
              if (
                data.card.height !== "change" &&
                data.card.backness === "change"
              ) {
                changeText = data.card.height;
              } else if (
                data.card.backness !== "change" &&
                data.card.height === "change"
              ) {
                changeText = data.card.backness;
              }
            }
            message = `${aiName} played ${data.card.symbol} (CHANGE to ${changeText}!)`;
            showSpeechBubble(aiIndex + 1, `🪄${changeText}🪄`);
            addLogEntry(message, "ai");
            addLogEntry(`${aiName}: "🪄${changeText}🪄"`, "ai-phrase");
          } else if (data.card.isPlusTwo) {
            message = `${aiName} played ${data.card.symbol} (+2!)`;
            addLogEntry(message, "ai");
          } else if (data.isReverse) {
            message = `${aiName} played ${data.card.symbol} (REVERSE!)`;
            addLogEntry(message, "ai");
          } else if (data.card.isSkip) {
            message = `${aiName} played ${data.card.symbol} (SKIP!)`;
            addLogEntry(message, "ai");
            if (typeof getAISkipPhrase === "function") {
              // Figure out which AI is being skipped
              let skippedIndex;
              if (gameDirection === 1) {
                skippedIndex = (aiIndex + 1) % 3;
              } else {
                skippedIndex = (aiIndex + 2) % 3;
              }
              // Only show skip phrase if the skipped player is an AI
              const skippedPlayerTurn = data.turn === 0 ? 3 : data.turn - 1;
              // FIX: Only show skip phrase if skippedPlayerTurn is not 0 (not human)
              if (skippedIndex !== -1 && skippedPlayerTurn !== 0) {
                const skippedName = aiNames[skippedIndex] || "Wug";
                showSpeechBubble(
                  skippedIndex + 1,
                  getAISkipPhrase(skippedName)
                );
                addLogEntry(
                  `${skippedName}: "${getAISkipPhrase(skippedName)}"`,
                  "ai-phrase"
                );
              }
            }
          } else {
            message = `${aiName} played ${data.card.symbol}`;
            addLogEntry(message, "ai");
          }
          // Update AI card count
          aiCardCounts[data.playerId]--;
          console.log(
            `Updated ${data.playerId} card count to:`,
            aiCardCounts[data.playerId]
          );
        }

        currentTurn = data.turn;
        isMyTurn = currentTurn === 0;
        isPlaying = false;
        // Update direction if a reverse card was played
        if (data.isReverse) {
          gameDirection *= -1;
          updateDirectionIndicator();
        }
        render();
        updateTurnIndicator();
      });

      socket.on("cardDrawn", (data) => {
        console.log("Card drawn:", data);

        if (data.playerId === socket.id) {
          if (data.isPlusTwo) {
            addLogEntry(
              `You drew ${data.cardsDrawn} cards due to +2!`,
              "player"
            );
          } else if (data.isPlusFour) {
            addLogEntry(
              `You drew ${data.cardsDrawn} cards because of +4!`,
              "player"
            );
          } else {
            addLogEntry("You drew a card", "player");
          }
        } else {
          const aiIndex = parseInt(data.playerId.split("_")[1]) - 1;
          const aiName = aiNames[aiIndex] || "Wug";
          if (data.isPlusFour) {
            addLogEntry(
              `${aiName} drew ${data.cardsDrawn} cards due to +4!`,
              "ai"
            );
            // Show AI plusFour phrase in speech bubble
            if (typeof getAIPlusFourPhrase === "function") {
              const phrase = getAIPlusFourPhrase(aiName);
              showSpeechBubble(aiIndex + 1, phrase);
              addLogEntry(`${aiName}: "${phrase}"`, "ai-phrase");
            }
          } else if (data.isPlusTwo) {
            addLogEntry(
              `${aiName} drew ${data.cardsDrawn} cards due to +2!`,
              "ai"
            );
            // Show AI plusTwo phrase in speech bubble
            if (typeof getAIPlusTwoPhrase === "function") {
              const phrase = getAIPlusTwoPhrase(aiName);
              showSpeechBubble(aiIndex + 1, phrase);
              addLogEntry(`${aiName}: "${phrase}"`, "ai-phrase");
            }
          } else {
            addLogEntry(`${aiName} drew a card`, "ai");
          }
          // Update AI card count
          aiCardCounts[data.playerId] += data.cardsDrawn ? data.cardsDrawn : 1;
          // Show AI draw phrase in speech bubble
          if (
            !data.isPlusTwo &&
            !data.isPlusFour &&
            typeof getAIDrawPhrase === "function"
          ) {
            const phrase = getAIDrawPhrase(aiName);
            showSpeechBubble(aiIndex + 1, phrase);
            addLogEntry(`${aiName}: "${phrase}"`, "ai-phrase");
          }
        }

        currentTurn = data.turn;
        isMyTurn = currentTurn === 0;
        isPlaying = false;
        render();
        updateTurnIndicator();
        // drawButton will be re-enabled in render() if isMyTurn
      });

      socket.on("unoCalled", (data) => {
        console.log("UNO called:", data);
        if (data.playerId === socket.id) {
          addLogEntry("🎉 UNO! You called UNO!", "uno");
        } else {
          const aiIndex = parseInt(data.playerId.split("_")[1]) - 1;
          const aiName = aiNames[aiIndex] || "Wug";
          addLogEntry(`🎉 UNO! ${aiName} called UNO!`, "uno");
          // Show speech bubble and highlight for AI
          showSpeechBubble(aiIndex + 1, "UNO!");
          const aiBox = document.getElementById(["ai1", "ai2", "ai3"][aiIndex]);
          if (aiBox) {
            aiBox.classList.add("uno-highlight");
            setTimeout(() => aiBox.classList.remove("uno-highlight"), 2000);
          }
        }
      });

      socket.on("unoCaught", (data) => {
        console.log("UNO caught:", data);
        const caughtAiIndex = parseInt(data.caughtPlayerId.split("_")[1]) - 1;
        const caughtAiName = aiNames[caughtAiIndex] || "Wug";

        // Update AI card count
        aiCardCounts[data.caughtPlayerId] += data.cardsDrawn;

        if (data.catcherId === socket.id) {
          addLogEntry(
            `🎯 You caught ${caughtAiName}! They drew ${data.cardsDrawn} card.`,
            "catch"
          );
        } else {
          addLogEntry(
            `🎯 ${caughtAiName} got caught! They drew ${data.cardsDrawn} card.`,
            "catch"
          );
        }

        // Re-render to update AI card counts and click handlers
        render();
      });

      socket.on("updateHand", (data) => {
        console.log("Hand updated:", data.hand);
        hand = data.hand;
        render();
      });

      socket.on("turnUpdate", (data) => {
        console.log("Turn updated:", data);
        currentTurn = data.turn;
        isMyTurn = currentTurn === 0;
        isPlaying = false;
        if (data.catchableAIs) {
          catchableAIs = data.catchableAIs;
        } else {
          catchableAIs = [];
        }
        updateTurnIndicator();
        render();

        // If it's now the human player's turn, check if they need to draw due to +2/+4
        if (isMyTurn) {
          socket.emit("startTurn", { roomId });
        }
      });

      socket.on("gameOver", (data) => {
        let winner;
        if (data.winner === socket.id) {
          winner = "You";
        } else {
          // Extract AI index and get the actual name
          const aiIndex = parseInt(data.winner.split("_")[1]) - 1;
          winner = aiNames[aiIndex] || "Wug";
        }
        addLogEntry(`Game Over! ${winner} won!`, "system");
        document.getElementById("drawButton").disabled = true;
        document.getElementById("hintButton").disabled = true;
        document.getElementById("unoButton").disabled = true;
        // Show fancy winner overlay
        showWinnerOverlay(winner);
      });

      socket.on("catchableAIsUpdate", (data) => {
        catchableAIs = data.catchableAIs || [];
        renderAIPlayers();
      });

      function showWinnerOverlay(winner) {
        const overlay = document.getElementById("winnerOverlay");
        const message = document.getElementById("winnerMessage");
        if (winner === "You") {
          message.textContent = "You won! 🎉";
        } else {
          message.textContent = winner + " wins! 🎉";
        }
        overlay.style.display = "flex";
        startConfetti();
      }
      // Hide overlay on reload or new game
      window.addEventListener("beforeunload", () => {
        document.getElementById("winnerOverlay").style.display = "none";
      });
      socket.on("startGame", () => {
        document.getElementById("winnerOverlay").style.display = "none";
      });
      // Simple confetti animation
      function startConfetti() {
        const canvas = document.getElementById("confettiCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let confetti = [];
        for (let i = 0; i < 120; i++) {
          confetti.push({
            x: Math.random() * canvas.width,
            y: Math.random() * -canvas.height,
            r: 6 + Math.random() * 10,
            d: 2 + Math.random() * 4,
            color: `hsl(${Math.random() * 360}, 80%, 60%)`,
            tilt: Math.random() * 10 - 5,
            tiltAngle: Math.random() * Math.PI * 2,
          });
        }
        let animationFrame;
        function draw() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          confetti.forEach((c) => {
            ctx.beginPath();
            ctx.ellipse(c.x, c.y, c.r, c.r / 2, c.tiltAngle, 0, 2 * Math.PI);
            ctx.fillStyle = c.color;
            ctx.fill();
          });
        }
        function update() {
          confetti.forEach((c) => {
            c.y += c.d;
            c.x += Math.sin(c.tiltAngle) * 2;
            c.tiltAngle += 0.05 + Math.random() * 0.02;
            if (c.y > canvas.height) {
              c.y = -10;
              c.x = Math.random() * canvas.width;
            }
          });
        }
        function loop() {
          draw();
          update();
          animationFrame = requestAnimationFrame(loop);
        }
        loop();
        // Stop confetti after 7 seconds
        setTimeout(() => {
          cancelAnimationFrame(animationFrame);
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }, 7000);
      }

      function restartGame() {
        restarting = true;
        socket.emit("joinGame", roomId, currentMode, currentDifficulty);
      }

      socket.on("error", (data) => {
        addLogEntry(`Error: ${data.message}`, "error");
      });

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
      }

      function render(showHints = false) {
        renderHand(showHints);
        renderPile();
        renderAIPlayers();
        // Re-enable draw button if it was disabled and it's my turn
        if (document.getElementById("drawButton").disabled && isMyTurn) {
          document.getElementById("drawButton").disabled = false;
        }
        // Re-enable hint button if it was disabled, it's my turn, and hints remain
        if (
          document.getElementById("hintButton").disabled &&
          isMyTurn &&
          hintRemaining > 0
        ) {
          document.getElementById("hintButton").disabled = false;
        }

        // Enable/disable UNO button based on hand size and turn
        const unoButton = document.getElementById("unoButton");
        let playableCount = 0;
        if (pileCard && hand.length > 0) {
          playableCount = hand.filter((card) => isMatch(card, pileCard)).length;
        }
        if (
          isMyTurn &&
          (hand.length === 1 ||
            (hand.length === 2 && playableCount > 0 && playableCount <= 2))
        ) {
          unoButton.disabled = false;
        } else {
          unoButton.disabled = true;
        }
      }

      function renderHand(showHints = false) {
        console.log("renderHand", isMyTurn, currentTurn);

        const handDiv = document.getElementById("hand");
        const hintMessage = document.getElementById("hintMessage");
        const hintCount = document.getElementById("hintCount");
        handDiv.innerHTML = "";
        if (hintMessage) hintMessage.textContent = "";
        let anyHints = false;
        let hasPlayable = false;

        // Overlap cards if more than 10
        if (hand.length > 10) {
          handDiv.classList.add("overlap");
        } else {
          handDiv.classList.remove("overlap");
        }

        if (hand.length === 0) {
          const loadingDiv = document.createElement("div");
          loadingDiv.innerHTML = "<p>Loading cards...</p>";
          handDiv.appendChild(loadingDiv);
          return;
        }

        hand.forEach((card, index) => {
          const div = document.createElement("div");
          div.className = "card";
          div.innerHTML = `<div>${card.symbol}</div>`;
          // Only show label for regular cards in easy mode
          if (
            currentDifficulty === "easy" &&
            !card.isPlusTwo &&
            !card.isPlusFour &&
            !card.isReverse &&
            !card.isChange &&
            !card.isSkip
          ) {
            div.innerHTML += `<span class="card-label">${
              currentMode === "consonant"
                ? card.place + ", " + card.manner
                : card.height + ", " + card.backness
            }</span>`;
          }

          // Add reverse class if it's a reverse card
          if (card.isReverse) {
            div.classList.add("reverse");
          }

          // Add plus-two class if it's a +2 card
          if (card.isPlusTwo) {
            div.classList.add("plus-two");
          }

          // Add plus-four class if it's a +4 card
          if (card.isPlusFour) {
            div.classList.add("plus-four");
          }

          // Add skip class if it's a skip card
          if (card.isSkip) {
            div.classList.add("skip");
          }

          if (isMatch(card, pileCard)) {
            hasPlayable = true;
          }
          if (showHints && isMatch(card, pileCard)) {
            div.classList.add("hint");
            anyHints = true;
          }
          if (isMyTurn) {
            div.onclick = () => playCard(index);
          }
          handDiv.appendChild(div);
        });

        const drawButton = document.getElementById("drawButton");
        if (showHints && !anyHints) {
          if (hintMessage)
            hintMessage.textContent =
              "No playable cards. Please draw a new one.";
          drawButton.classList.add("highlight-draw");
          addLogEntry("No playable card, draw a new card!", "system");
        } else {
          drawButton.classList.remove("highlight-draw");
        }
        if (hintCount) hintCount.textContent = hintRemaining;
      }

      function renderPile() {
        const pileDiv = document.getElementById("pile");
        pileDiv.innerHTML = "";

        if (pileCard) {
          const div = document.createElement("div");
          div.className = "card pile-card";

          // Special display for change cards
          if (pileCard.isChange) {
            let changeText = "";
            if (currentMode === "consonant") {
              if (pileCard.place !== "change") {
                changeText = pileCard.place;
              } else if (pileCard.manner !== "change") {
                changeText = pileCard.manner;
              }
            } else {
              if (pileCard.height !== "change") {
                changeText = pileCard.height;
              } else if (pileCard.backness !== "change") {
                changeText = pileCard.backness;
              }
            }
            div.innerHTML = `<div>🪄${changeText}🪄</div>`;
          } else {
            div.innerHTML = `<div>${pileCard.symbol}</div>`;
          }
          // Only show label for regular cards in easy mode
          if (
            currentDifficulty === "easy" &&
            !pileCard.isPlusTwo &&
            !pileCard.isPlusFour &&
            !pileCard.isReverse &&
            !pileCard.isChange &&
            !pileCard.isSkip
          ) {
            div.innerHTML += `<span class="card-label">${
              currentMode === "consonant"
                ? pileCard.place + ", " + pileCard.manner
                : pileCard.height + ", " + pileCard.backness
            }</span>`;
          }

          // Add reverse class if it's a reverse card
          if (pileCard.isReverse) {
            div.classList.add("reverse");
          }

          // Add plus-two class if it's a +2 card
          if (pileCard.isPlusTwo) {
            div.classList.add("plus-two");
          }

          // Add plus-four class if it's a +4 card
          if (pileCard.isPlusFour) {
            div.classList.add("plus-four");
          }

          // Add skip class if it's a skip card
          if (pileCard.isSkip) {
            div.classList.add("skip");
          }

          pileDiv.appendChild(div);
        }
      }

      function renderAIPlayers() {
        console.log("renderAIPlayers: currentTurn =", currentTurn);
        // Update AI 1 (left)
        const ai1 = document.getElementById("ai1");
        const ai1Cards = document.getElementById("ai1Cards");
        ai1Cards.innerHTML = "";
        for (let i = 0; i < aiCardCounts.ai_1; i++) {
          const cardDiv = document.createElement("div");
          cardDiv.className = "ai-card back";
          // No question mark, just the Wug image
          ai1Cards.appendChild(cardDiv);
        }
        ai1.querySelector("h3").textContent = aiNames[0] || "Bibi";
        // Update AI 2 (top)
        const ai2 = document.getElementById("ai2");
        const ai2Cards = document.getElementById("ai2Cards");
        ai2Cards.innerHTML = "";
        for (let i = 0; i < aiCardCounts.ai_2; i++) {
          const cardDiv = document.createElement("div");
          cardDiv.className = "ai-card back";
          // No question mark, just the Wug image
          ai2Cards.appendChild(cardDiv);
        }
        ai2.querySelector("h3").textContent = aiNames[1] || "Sass";
        // Update AI 3 (right)
        const ai3 = document.getElementById("ai3");
        const ai3Cards = document.getElementById("ai3Cards");
        ai3Cards.innerHTML = "";
        for (let i = 0; i < aiCardCounts.ai_3; i++) {
          const cardDiv = document.createElement("div");
          cardDiv.className = "ai-card back";
          // No question mark, just the Wug image
          ai3Cards.appendChild(cardDiv);
        }
        ai3.querySelector("h3").textContent = aiNames[2] || "Mimi";
        // Update active states
        ai1.className = "ai-player ai-1" + (currentTurn === 1 ? " active" : "");
        ai2.className = "ai-player ai-2" + (currentTurn === 2 ? " active" : "");
        ai3.className = "ai-player ai-3" + (currentTurn === 3 ? " active" : "");
        if (currentTurn === 1) console.log("AI 1 highlighted");
        if (currentTurn === 2) console.log("AI 2 highlighted");
        if (currentTurn === 3) {
          console.log("AI 3 highlighted");
          console.log("AI 3 className:", ai3.className);
          console.log("AI 3 card count:", aiCardCounts.ai_3);
        }
        // Human highlight
        const humanBox = document.getElementById("humanBox");
        humanBox.className = `human-player${
          currentTurn === 0 ? " active" : ""
        }`;

        // Add click handlers for catching AI players
        if (isMyTurn) {
          if (catchableAIs.includes("ai_1")) {
            ai1.style.cursor = "pointer";
            ai1.onclick = () => catchUno("ai_1");
          } else {
            ai1.style.cursor = "default";
            ai1.onclick = null;
          }

          if (catchableAIs.includes("ai_2")) {
            ai2.style.cursor = "pointer";
            ai2.onclick = () => catchUno("ai_2");
          } else {
            ai2.style.cursor = "default";
            ai2.onclick = null;
          }

          if (catchableAIs.includes("ai_3")) {
            ai3.style.cursor = "pointer";
            ai3.onclick = () => catchUno("ai_3");
          } else {
            ai3.style.cursor = "default";
            ai3.onclick = null;
          }
        } else {
          // Remove click handlers when not player's turn
          ai1.style.cursor = "default";
          ai1.onclick = null;
          ai2.style.cursor = "default";
          ai2.onclick = null;
          ai3.style.cursor = "default";
          ai3.onclick = null;
        }
      }

      function updateTurnIndicator() {
        // No-op: turn indicator has been removed from the UI
      }

      function updateDirectionIndicator() {
        const indicator = document.getElementById("directionIndicator");
        if (indicator) {
          if (gameDirection === 1) {
            indicator.textContent = "↻ Clockwise";
            indicator.style.color = "#2196f3";
            indicator.style.borderColor = "#2196f3";
          } else {
            indicator.textContent = "↺ Counterclockwise";
            indicator.style.color = "#ff5722";
            indicator.style.borderColor = "#ff5722";
          }
        }
      }

      function addLogEntry(message, type) {
        const logDiv = document.getElementById("actionLog");
        const entry = document.createElement("div");
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function showSpeechBubble(aiNumber, message) {
        const bubble = document.getElementById(`speechBubble${aiNumber}`);
        if (bubble) {
          bubble.textContent = message;
          bubble.classList.add("show");

          // Hide the bubble after 5 seconds (longer since game is much slower)
          setTimeout(() => {
            bubble.classList.remove("show");
          }, 5000);
        }
      }

      function playCard(index) {
        if (!isMyTurn || isPlaying) {
          addLogEntry("Not your turn!", "error");
          return;
        }
        isPlaying = true;
        isMyTurn = false; // Immediately prevent further plays
        document.getElementById("drawButton").disabled = true;
        document.getElementById("hintButton").disabled = true;
        document.getElementById("unoButton").disabled = true;
        render(); // This will re-render the hand with no click handlers

        const card = hand[index];
        // Intercept change card (🪄)
        if (card.isChange) {
          showChangeModal(card, index);
          return;
        }
        if (isMatch(card, pileCard)) {
          socket.emit("playCard", { roomId, cardIndex: index });
        } else {
          addLogEntry("Card does not match!", "error");
          // Allow player to try again:
          isMyTurn = true;
          isPlaying = false;
          document.getElementById("drawButton").disabled = false;
          if (hintRemaining > 0)
            document.getElementById("hintButton").disabled = false;
          // Re-enable UNO button if player has 1 card
          if (hand.length === 1)
            document.getElementById("unoButton").disabled = false;
          render();
        }
      }

      // Show the change card modal
      function showChangeModal(card, cardIndex) {
        const modal = document.getElementById("changeModal");
        const optionsDiv = document.getElementById("changeOptions");
        optionsDiv.innerHTML = "";
        // Determine mode
        if (currentMode === "consonant") {
          // Radio buttons for place or manner
          const radioDiv = document.createElement("div");
          radioDiv.style.marginBottom = "12px";
          radioDiv.innerHTML = `
            <label><input type="radio" name="changeDim" value="place" checked> Place of Articulation</label>
            <label style="margin-left:16px;"><input type="radio" name="changeDim" value="manner"> Manner of Articulation</label>
          `;
          optionsDiv.appendChild(radioDiv);
          // Place dropdown
          const placeSelect = document.createElement("select");
          placeSelect.id = "changePlace";
          [
            "bilabial",
            "labiodental",
            "dental",
            "alveolar",
            "postalveolar",
            "retroflex",
            "palatal",
            "velar",
            "uvular",
            "pharyngeal",
            "glottal",
          ].forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p;
            opt.textContent = p.charAt(0).toUpperCase() + p.slice(1);
            placeSelect.appendChild(opt);
          });
          optionsDiv.appendChild(placeSelect);
          // Manner dropdown
          const mannerSelect = document.createElement("select");
          mannerSelect.id = "changeManner";
          mannerSelect.style.display = "none";
          [
            "plosive",
            "nasal",
            "trill",
            "tap",
            "fricative",
            "affricate",
            "approximant",
            "lateral approximant",
          ].forEach((m) => {
            const opt = document.createElement("option");
            opt.value = m;
            opt.textContent = m.charAt(0).toUpperCase() + m.slice(1);
            mannerSelect.appendChild(opt);
          });
          optionsDiv.appendChild(mannerSelect);
          // Radio change event
          radioDiv
            .querySelectorAll('input[name="changeDim"]')
            .forEach((radio) => {
              radio.onchange = function () {
                if (this.value === "place") {
                  placeSelect.style.display = "";
                  mannerSelect.style.display = "none";
                } else {
                  placeSelect.style.display = "none";
                  mannerSelect.style.display = "";
                }
              };
            });
        } else {
          // Vowel mode: height or backness
          const radioDiv = document.createElement("div");
          radioDiv.style.marginBottom = "12px";
          radioDiv.innerHTML = `
            <label><input type="radio" name="changeDim" value="height" checked> Height</label>
            <label style="margin-left:16px;"><input type="radio" name="changeDim" value="backness"> Backness</label>
          `;
          optionsDiv.appendChild(radioDiv);
          // Height dropdown
          const heightSelect = document.createElement("select");
          heightSelect.id = "changeHeight";
          [
            "close",
            "near-close",
            "close-mid",
            "mid",
            "open-mid",
            "near-open",
            "open",
          ].forEach((h) => {
            const opt = document.createElement("option");
            opt.value = h;
            opt.textContent = h.charAt(0).toUpperCase() + h.slice(1);
            heightSelect.appendChild(opt);
          });
          optionsDiv.appendChild(heightSelect);
          // Backness dropdown
          const backSelect = document.createElement("select");
          backSelect.id = "changeBackness";
          backSelect.style.display = "none";
          ["front", "central", "back"].forEach((b) => {
            const opt = document.createElement("option");
            opt.value = b;
            opt.textContent = b.charAt(0).toUpperCase() + b.slice(1);
            backSelect.appendChild(opt);
          });
          optionsDiv.appendChild(backSelect);
          // Radio change event
          radioDiv
            .querySelectorAll('input[name="changeDim"]')
            .forEach((radio) => {
              radio.onchange = function () {
                if (this.value === "height") {
                  heightSelect.style.display = "";
                  backSelect.style.display = "none";
                } else {
                  heightSelect.style.display = "none";
                  backSelect.style.display = "";
                }
              };
            });
        }
        modal.style.display = "flex";
        // Handle form submit
        const form = document.getElementById("changeForm");
        form.onsubmit = function (e) {
          e.preventDefault();
          let payload = { roomId, cardIndex };
          if (currentMode === "consonant") {
            const dim = optionsDiv.querySelector(
              'input[name="changeDim"]:checked'
            ).value;
            if (dim === "place") {
              payload.changePlace =
                document.getElementById("changePlace").value;
            } else {
              payload.changeManner =
                document.getElementById("changeManner").value;
            }
          } else {
            const dim = optionsDiv.querySelector(
              'input[name="changeDim"]:checked'
            ).value;
            if (dim === "height") {
              payload.changeHeight =
                document.getElementById("changeHeight").value;
            } else {
              payload.changeBackness =
                document.getElementById("changeBackness").value;
            }
          }
          modal.style.display = "none";
          socket.emit("playCard", payload);
        };
      }

      function drawCard() {
        if (!isMyTurn) {
          addLogEntry("Not your turn!", "error");
          return;
        }
        document.getElementById("drawButton").disabled = true;
        document.getElementById("hintButton").disabled = true;
        document.getElementById("unoButton").disabled = true;
        isMyTurn = false;
        socket.emit("drawCard", { roomId });
      }

      function showHint() {
        if (!isMyTurn || hintRemaining <= 0) return;
        socket.emit("showHint");
        hintRemaining--;
        document.getElementById(
          "hintButton"
        ).textContent = `Hint (${hintRemaining} left)`;
        addLogEntry("You used a hint", "player");
        // Do not disable drawButton after hint
        render(true);
      }

      function callUno() {
        if (!isMyTurn) {
          addLogEntry("Not your turn!", "error");
          return;
        }
        if (hand.length !== 1) {
          addLogEntry(
            "You can only call UNO when you have exactly 1 card!",
            "error"
          );
          return;
        }
        socket.emit("callUno", { roomId });
        addLogEntry("You called UNO!", "player");
        document.getElementById("unoButton").disabled = true;
      }

      function catchUno(aiId) {
        if (!isMyTurn) {
          addLogEntry("Not your turn!", "error");
          return;
        }
        if (aiCardCounts[aiId] !== 1) {
          addLogEntry(
            "You can only catch an AI when they have exactly 1 card!",
            "error"
          );
          return;
        }
        socket.emit("catchUno", { roomId, aiId });
        addLogEntry(
          `You caught ${aiNames[parseInt(aiId.split("_")[1]) - 1] || "Wug"}!`,
          "player"
        );
      }

      function isMatch(card, pileCard) {
        if (!pileCard) return true; // If no pile card, any card is playable
        if (card.symbol === pileCard.symbol) return true;
        if (card.symbol === "W" && pileCard.symbol === "U") return true;
        if (card.symbol === "U" && pileCard.symbol === "W") return true;
        // +4 cards can be played on any card, and any card can be played on a +4 card
        if (card.isPlusFour || pileCard.isPlusFour) return true;
        // +2 cards can be played on any card, and any card can be played on a +2 card
        if (card.isPlusTwo || pileCard.isPlusTwo) return true;
        // Reverse cards can be played on any card
        if (card.isReverse || pileCard.isReverse) return true;
        // Skip cards can be played on any card, and any card can be played on a skip card
        if (card.isSkip || pileCard.isSkip) return true;
        return card.place === pileCard.place || card.manner === pileCard.manner;
      }

      // Initial render to set up the game board and hand
      render();
      document.getElementById("helpButton").onclick = function () {
        document.getElementById("helpModal").style.display = "flex";
      };
      document.getElementById("closeHelpModal").onclick = function () {
        document.getElementById("helpModal").style.display = "none";
      };
      window.onclick = function (event) {
        const modal = document.getElementById("helpModal");
        if (event.target === modal) {
          modal.style.display = "none";
        }
      };
    </script>
  </body>
</html>
